<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Metabuscador CGR</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      /* PALETA A ‚Äî SIT + Conectividad A√©rea */

      /* Primarios */
      --azul-profundo: #3366CC;
      --cyan-corporativo: #1EA3D5;
      --blanco: #FFFFFF;

      /* Secundarios */
      --morado-acento: #AA609D;
      --naranja-suave: #EDC29E;
      --gris-azulado: #CDD4DE;

      /* Soporte */
      --gris-texto: #7D8A96;
      --gris-borde: #D1D7E0;
      --gris-chip: #F7F9FC;
    }

    body {
      background: var(--gris-chip);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      overflow-x: hidden;
    }

    /* SIDEBAR */
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: 260px;
      height: 100vh;
      background: var(--azul-profundo);
      color: var(--blanco);
      z-index: 1000;
      box-shadow: 2px 0 4px rgba(0, 0, 0, 0.08);
      overflow-y: auto;
      transition: transform 0.3s ease;
      border-right: 1px solid var(--gris-azulado);
    }

    .sidebar-header {
      padding: 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--gris-borde);
      background: var(--blanco);
    }

    .sidebar-logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .sidebar-logo img {
      height: 55px;
    }

    .sidebar-logo-text {
      font-size: 18px;
      font-weight: 600;
      color: var(--azul-profundo);
    }

    .sidebar-section {
      padding: 20px 0;
      border-bottom: 1px solid var(--gris-azulado);
    }

    .sidebar-section h6 {
      color: var(--blanco);
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 0 20px;
      margin-bottom: 10px;
    }

    .sidebar a {
      display: flex;
      align-items: center;
      padding: 10px 20px;
      color: var(--gris-texto);
      text-decoration: none;
      transition: all 0.2s ease;
      font-size: 14px;
    }

    .sidebar.hidden {
      transform: translateX(-260px);
    }

    .sidebar a:hover {
      background: rgba(255, 255, 255, 0.15);
      color: var(--blanco);
    }

    .sidebar a.active {
      background: rgba(255, 255, 255, 0.10);
      color: var(--blanco);
      border-left: 3px solid var(--corporativo-azul);
      font-weight: 500;
    }

    .sidebar a i {
      width: 24px;
      margin-right: 12px;
      font-size: 16px;
    }

    .sidebar-toggle {
      background: transparent;
      border: none;
      padding: 8px;
      cursor: pointer;
      color: var(--gris-azulado);
      font-size: 18px;
      border-radius: 50%;
      transition: all 0.2s ease;
    }

    .sidebar-toggle:hover {
      background: var(--gris-azulado);
    }

    /* TOPBAR */
    .topbar {
      position: fixed;
      top: 0;
      left: 260px;
      right: 0;
      height: 60px;
      background: var(--azul-profundo);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      z-index: 999;
      transition: left 0.3s ease;
    }

    .topbar.expanded {
      left: 0;
    }

    .topbar-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .menu-toggle {
      background: rgba(255, 255, 255, 0.1);
      border: none;
      font-size: 20px;
      color: var(--blanco);
      cursor: pointer;
      padding: 8px;
      border-radius: 4px;
      transition: all 0.2s ease;
    }

    .menu-toggle:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .topbar-title {
      font-size: 20px;
      font-weight: 500;
      color: var(--blanco);
    }

    .topbar-actions {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .topbar-input {
      padding: 6px 12px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 4px;
      font-size: 13px;
      width: 140px;
      background: rgba(255, 255, 255);
      color: var(--gris-texto);
    }

    .topbar-input:focus {
      outline: none;
      background: var(--blanco);
      border-color: var(--naranja-suave);
    }

    .btn-historial {
      background: var(--naranja-suave);
      color: var(--azul-profundo);
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      font-weight: 500;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-historial:hover {
      background: var(--naranja-suave);
      transform: translateY(-1px);
    }

    .btn-logout {
      background: var(--morado-acento);
      color: var(--blanco);
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      font-weight: 500;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-logout:hover {
      background: var(--morado-acento);
      transform: translateY(-1px);
    }

    /* MAIN CONTENT */
    .main-content {
      margin-left: 260px;
      margin-top: 60px;
      padding: 20px;
      min-height: calc(100vh - 60px);
      transition: margin-left 0.3s ease;
    }

    .main-content.expanded {
      margin-left: 0;
    }

    /* HISTORIAL LATERAL */
    .historial-lateral {
      position: fixed;
      right: -320px;
      top: 60px;
      width: 320px;
      height: calc(100vh - 60px);
      background: var(--blanco);
      box-shadow: -2px 0 8px rgba(0, 0, 0, 0.1);
      z-index: 998;
      overflow-y: auto;
      transition: right 0.3s ease;
      padding: 20px;
    }

    .historial-lateral.visible {
      right: 0;
    }

    .historial-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #e0e0e0;
    }

    .historial-header h3 {
      font-size: 16px;
      font-weight: 500;
      color: #202124;
      margin: 0;
    }

    .historial-close {
      background: transparent;
      border: none;
      font-size: 20px;
      color: #5f6368;
      cursor: pointer;
      padding: 4px;
      border-radius: 50%;
      transition: all 0.2s ease;
    }

    .historial-close:hover {
      background: #f0f0f0;
    }

    .historial-item {
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 10px;
      background: #f8f9fa;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 13px;
      color: #5f6368;
    }

    .historial-item:hover {
      background: #e8f0fe;
      color: #1967d2;
    }

    .main-content.with-historial {
      margin-right: 320px;
    }

    /* CONSULTA SECTION */
    .consulta-container {
      background: var(--blanco);
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
      padding: 24px;
      margin-bottom: 20px;
      border-top: 3px solid var(--cyan-corporativo);
    }

    .consulta-header {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--gris-azulado);
    }

    .consulta-header i {
      font-size: 24px;
      color: var(--morado-acento);
      margin-right: 12px;
    }

    .consulta-header h2 {
      font-size: 18px;
      font-weight: 500;
      color: var(--gris-texto);
      margin: 0;
    }

    .search-input-wrapper {
      position: relative;
      margin-bottom: 15px;
    }

    .search-input {
      width: 100%;
      padding: 14px 50px 14px 16px;
      border: 2px solid var(--gris-borde);
      border-radius: 6px;
      font-size: 15px;
      transition: all 0.2s ease;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--cyan-corporativo);
      box-shadow: 0 2px 8px rgba(45, 62, 128, 0.15);
    }

    .search-input-icon {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: var(--azul-profundo);
      border: none;
      color: var(--blanco);
      width: 36px;
      height: 36px;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .search-input-icon:hover {
      background: var(--cyan-corporativo);
    }

    .btn-new-chat {
      margin-left: 15px;
      border: none;
      color: #000000;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      font-size: 14px;
    }

    .btn-new-chat:hover {
      background: #8e44ad;
      transform: scale(1.1);
    }


    .btn-new-chat {
      position: absolute;
      left: -50px;
      top: 50%;
      transform: translateY(-50%);
      background: var(--morado-acento);
      border: none;
      color: var(--blanco);
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .btn-new-chat:hover {
      background: #8e44ad;
      transform: translateY(-50%) scale(1.05);
    }

    .sugerencias-preguntas {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 15px;
    }

    .sugerencia-chip {
      background: var(--gris-chip);
      border: 1px solid var(--gris-borde);
      border-radius: 16px;
      padding: 6px 14px;
      font-size: 12px;
      color: var(--gris-texto);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .sugerencia-chip:hover {
      background: var(--morado-acento);
      color: var(--blanco);
      border-color: var(--gris-borde);
    }

    /* RESPUESTA SECTION */
    .respuesta-container {
      background: var(--blanco);
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
      padding: 24px;
      margin-bottom: 20px;
      border-left: 4px solid var(--naranja-suave);
    }

    .respuesta-header {
      display: flex;
      align-items: center;
      margin-bottom: 16px;
    }

    .respuesta-header i {
      font-size: 24px;
      color: var(--morado-acento);
      margin-right: 12px;
    }

    .respuesta-header h3 {
      font-size: 16px;
      font-weight: 500;
      color: var(--gris-texto);
      margin: 0;
    }

    .respuesta-content {
      background: var(--gris-azulado);
      border-radius: 6px;
      padding: 16px;
      line-height: 1.6;
      color: var(--gris-texto);
      font-size: 14px;
      max-height: 60vh;
      /* Responsive height */
      overflow: auto;
      /* Scroll both axes if needed */
      width: 100%;
    }

    /* Custom Scrollbar for Chat */
    .respuesta-content::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    .respuesta-content::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.05);
      border-radius: 4px;
    }

    .respuesta-content::-webkit-scrollbar-thumb {
      background: #bdc3c7;
      border-radius: 4px;
    }

    .respuesta-content::-webkit-scrollbar-thumb:hover {
      background: #95a5a6;
    }

    .respuesta-content p {
      margin-bottom: 12px;
    }

    .respuesta-content p:last-child {
      margin-bottom: 0;
    }

    .respuesta-content strong {
      color: var(--morado-acento);
    }

    /* CHAT STYLES */
    .interaction-item {
      margin-bottom: 24px;
      border-bottom: 1px solid var(--gris-borde);
      padding-bottom: 20px;
      animation: fadeIn 0.3s ease;
    }

    .interaction-item:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .chat-question {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 15px;
      background: #f1f3f4;
      padding: 12px;
      border-radius: 8px 8px 8px 0;
      font-weight: 500;
      color: var(--azul-profundo);
    }

    .chat-answer {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 12px;
      background: #fbfbfb;
      border-radius: 0 8px 8px 8px;
      border-left: 3px solid var(--naranja-suave);
    }

    .chat-icon {
      font-size: 18px;
      margin-top: 3px;
      min-width: 24px;
    }

    .chat-content {
      flex: 1;
      font-size: 14px;
      line-height: 1.6;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* TABS */
    .tabs-container {
      display: flex;
      gap: 20px;
      margin-bottom: 30px;
    }

    .tab-card {
      flex: 1;
      background: var(--blanco);
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
      overflow: hidden;
    }

    .tab-header {
      background: #f8f9fa;
      padding: 15px 20px;
      border-bottom: 2px solid #dee2e6;
    }

    .tab-nav {
      display: flex;
      gap: 10px;
    }

    .tab-btn {
      padding: 8px 16px;
      background: transparent;
      border: none;
      border-radius: 6px;
      font-weight: 500;
      color: #6c757d;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .tab-btn.active {
      background: #0d6efd;
      color: var(--blanco);
    }

    .tab-content-area {
      padding: 20px;
      min-height: 200px;
    }

    /* GRAFICA */
    .grafica-container {
      background: var(--blanco);
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
      padding: 24px;
      margin-bottom: 20px;
    }

    .grafica-header {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--gris-chip);
    }

    .grafica-header i {
      font-size: 24px;
      color: var(--naranja-suave);
      margin-right: 12px;
    }

    .grafica-header h3 {
      font-size: 16px;
      font-weight: 500;
      color: var(--gris-texto);
      margin: 0;
    }

    .chart-wrapper {
      position: relative;
      height: 300px;
    }

    /* TABLA */
    .tabla-container {
      background: var(--blanco);
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
      padding: 24px;
    }

    .tabla-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--gris-chip);
    }

    .tabla-title {
      display: flex;
      align-items: center;
    }

    .tabla-title i {
      font-size: 24px;
      color: var(--azul-profundo);
      margin-right: 12px;
    }

    .tabla-title h3 {
      font-size: 16px;
      font-weight: 500;
      color: var(--gris-texto);
      margin: 0;
    }

    .badge-contador {
      background: var(--cyan-corporativo);
      color: var(--blanco);
      padding: 6px 14px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 13px;
    }

    .tabla-actions {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .btn-sm {
      padding: 7px 14px;
      border-radius: 4px;
      font-size: 13px;
      font-weight: 500;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-primary {
      background: var(--azul-profundo);
      color: var(--blanco);
    }

    .btn-primary:hover {
      background: var(--cyan-corporativo);
    }

    .btn-secondary {
      background: var(--gris-texto);
      color: var(--blanco);
    }

    .btn-secondary:hover {
      background: #616161;
    }

    .btn-success {
      background: var(--cyan-corporativo);
      color: var(--blanco);
      font-weight: 600;
    }

    .btn-success:hover {
      color: #000000;
    }

    .btn-info {
      background: var(--gris-azulado);
      color: var(--azul-profundo);
    }

    .btn-info:hover {
      background: #BDBDBD;
    }

    .btn-sm:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .tabla-excel-container {
      width: 100%;
      max-height: 400px;
      overflow: auto;
      border: 1px solid #dee2e6;
      border-radius: 8px;
    }

    .tabla-excel {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .tabla-excel thead {
      position: sticky;
      top: 0;
      z-index: 10;
      background: var(--azul-profundo);
    }

    .tabla-excel thead th {
      background: var(--azul-profundo);
      color: var(--blanco);
      padding: 12px 10px;
      text-align: left;
      font-weight: 600;
      border: 1px solid var(--cyan-corporativo);
      white-space: nowrap;
    }

    .tabla-excel tbody tr {
      border-bottom: 1px solid #e0e0e0;
      transition: background 0.2s ease;
    }

    .tabla-excel tbody tr:hover {
      background: #f8f9fa;
    }

    .tabla-excel tbody tr.selected {
      background: rgba(240, 184, 65, 0.15);
    }

    .tabla-excel tbody td {
      padding: 10px;
      border: 1px solid var(--gris-chip);
      white-space: nowrap;
    }

    /* SCROLLBAR */
    .tabla-excel-container::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }

    .tabla-excel-container::-webkit-scrollbar-track {
      background: var(--gris-azulado);
    }

    .tabla-excel-container::-webkit-scrollbar-thumb {
      background: var(--gris-texto);
      border-radius: 5px;
    }

    .tabla-excel-container::-webkit-scrollbar-thumb:hover {
      background: var(--gris-texto);
    }

    /* RESPONSIVE */
    @media (max-width: 992px) {
      .sidebar {
        transform: translateX(-260px);
      }

      .sidebar.visible {
        transform: translateX(0);
      }

      .topbar,
      .main-content {
        margin-left: 0;
        left: 0;
      }

      .historial-lateral {
        width: 100%;
      }

      .main-content.with-historial {
        margin-right: 0;
      }
    }

    /* FIX: Force reset of New Chat button styles */
    .btn-new-chat {
      position: static !important;
      left: auto !important;
      top: auto !important;
      transform: none !important;
      box-shadow: none !important;
      margin-left: 15px !important;
      background: var(--morado-acento) !important;
      color: var(--blanco) !important;
      width: 32px !important;
      height: 32px !important;
      min-width: 32px;
    }
  </style>
</head>

<body>

  <!-- SIDEBAR -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo">
        <img src="D:\Otros Contratos\Eafit\Turismo\Agente1\Front_Agente\alcadiademedellin.webp"
          alt="Logo Alcald√≠a de Medell√≠n">
        <span class="sidebar-logo-text"></span>
      </div>
      <button class="sidebar-toggle" onclick="toggleSidebar()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="sidebar-section">
      <h6>Men√∫ Principal</h6>
      <a href="#" class="active">
        <i class="fas fa-chart-pie"></i>
        <span>Analista de Turismo</span>
      </a>
      <a href="#">
        <i class="fas fa-robot"></i>
        <span>Agente Turismo</span>
      </a>
    </div>

    <div class="sidebar-section">
      <h6>Configuraci√≥n</h6>
      <a href="#">
        <i class="fas fa-cog"></i>
        <span>Ajustes</span>
      </a>
    </div>
  </div>

  <!-- TOPBAR -->
  <div class="topbar" id="topbar">
    <div class="topbar-left">
      <button class="menu-toggle" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
      </button>
      <div class="topbar-title">Analista de Turismo SIT</div>
    </div>
    <div class="topbar-actions">
      <h6 class="topbar-input">Fecha: 2025-12-27</h6>
      <h6 class="topbar-input">Usuario 1</h6>
      <button class="btn-historial" onclick="toggleHistorial()">
        <i class="fas fa-history"></i> Historial
      </button>
      <button class="btn-logout" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i> Cerrar sesi√≥n
      </button>
    </div>
  </div>

  <!-- HISTORIAL LATERAL -->
  <div class="historial-lateral" id="historialLateral">
    <div class="historial-header">
      <h3><i class="fas fa-history"></i> Historial</h3>
      <button class="historial-close" onclick="toggleHistorial()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div id="historialContent">
      <!-- El historial se llenar√° din√°micamente -->
    </div>
  </div>

  <!-- MAIN CONTENT -->
  <div class="main-content" id="mainContent">

    <!-- RESPUESTA DEL AGENTE (AHORA ARRIBA) -->
    <div class="respuesta-container" id="respuestaContainer" style="display: none;">
      <div class="respuesta-header">
        <i class="fas fa-robot"></i>
        <h3>Respuesta</h3>
      </div>
      <div class="respuesta-content" id="respuestaContent">
        <!-- La respuesta aparecer√° aqu√≠ -->
      </div>
    </div>

    <!-- CONSULTA DEL AGENTE -->
    <div class="consulta-container">
      <div class="consulta-header">
        <i class="fas fa-lightbulb"></i>
        <h2>Hacer una pregunta de muestra</h2>
        <button type="button" class="btn-new-chat" onclick="nuevoChat()" title="Nuevo Chat (Reiniciar Memoria)">
          <i class="fas fa-plus"></i>
        </button>
      </div>

      <form onsubmit="event.preventDefault(); consultarAgente()">
        <!-- Buscador principal estilo Google -->
        <div class="search-input-wrapper">
          <input type="text" class="search-input" id="preguntaInput" placeholder="Haz una pregunta...">
          <button type="submit" class="search-input-icon">
            <i class="fas fa-arrow-right"></i>
          </button>
        </div>

        <!-- Sugerencias de preguntas -->
        <!-- Sugerencias de preguntas (Historial Reciente) -->
        <div class="sugerencias-preguntas" id="sugerenciasContainer">
          <!-- Se llenar√° din√°micamente con las √∫ltimas 6 preguntas -->
        </div>
      </form>
    </div>

    <!-- RESPUESTA DEL AGENTE -->
    <div class="respuesta-container" id="respuestaContainer" style="display: none;">
      <div class="respuesta-header">
        <i class="fas fa-robot"></i>
        <h3>Respuesta</h3>
      </div>
      <div class="respuesta-content" id="respuestaContent">
        <!-- La respuesta aparecer√° aqu√≠ -->
      </div>
    </div>

    <!-- GR√ÅFICA -->
    <div class="grafica-container" id="graficaContainer" style="display: none;">
      <div class="grafica-header">
        <i class="fas fa-chart-bar"></i>
        <h3>Gr√°fica de Resultados</h3>
      </div>
      <div class="chart-wrapper">
        <canvas id="chartCanvas"></canvas>
      </div>
    </div>

    <!-- TABLA DE RESULTADOS -->
    <div class="tabla-container" id="tablaContainer" style="display: none;">
      <div class="tabla-header">
        <div class="tabla-title">
          <i class="fas fa-table"></i>
          <h3>Resultados de la Consulta</h3>
        </div>
        <span class="badge-contador" id="contadorSeleccionados">0 seleccionados</span>
      </div>

      <div class="tabla-actions">
        <button class="btn-sm btn-primary" onclick="seleccionarTodos()">
          <i class="fas fa-check-square"></i> Seleccionar Todos
        </button>
        <button class="btn-sm btn-secondary" onclick="deseleccionarTodos()">
          <i class="far fa-square"></i> Deseleccionar Todos
        </button>
        <button class="btn-sm btn-success" onclick="exportarSeleccionados()">
          <i class="fas fa-download"></i> Exportar
        </button>
        <button class="btn-sm btn-info" onclick="copiarSeleccionados()">
          <i class="fas fa-copy"></i> Copiar
        </button>
      </div>

      <div class="tabla-excel-container">
        <table class="tabla-excel" id="tablaResultados">
          <!-- La tabla se generar√° din√°micamente -->
        </table>
      </div>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Variables globales
    let chartInstance = null;

    // Datos de ejemplo
    const datosTabla = [
      { ID: '001', Contrato: 'Construcci√≥n Puente', Entidad: 'Gobernaci√≥n Valle', Valor: '$2,497,950,000', Estado: 'Activo', Departamento: 'Valle del Cauca', Municipio: 'Cali' },
      { ID: '002', Contrato: 'Estudios Infraestructura', Entidad: 'Alcald√≠a Medell√≠n', Valor: '$727,914,000', Estado: 'En proceso', Departamento: 'Antioquia', Municipio: 'Medell√≠n' },
      { ID: '003', Contrato: 'Servicios Educativos', Entidad: 'Secretar√≠a Educaci√≥n', Valor: '$600,000,000', Estado: 'Finalizado', Departamento: 'Antioquia', Municipio: 'Medell√≠n' }
    ];

    // Toggle sidebar
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const topbar = document.getElementById('topbar');
      const mainContent = document.getElementById('mainContent');

      sidebar.classList.toggle('hidden');
      topbar.classList.toggle('expanded');
      mainContent.classList.toggle('expanded');
    }

    // Toggle historial lateral
    function toggleHistorial() {
      const historial = document.getElementById('historialLateral');
      const mainContent = document.getElementById('mainContent');

      historial.classList.toggle('visible');
      mainContent.classList.toggle('with-historial');
    }

    // Cargar consulta del historial
    function cargarConsultaHistorial(pregunta) {
      document.getElementById('preguntaInput').value = pregunta;
      document.getElementById('preguntaInput').focus();
    }

    // Seleccionar sugerencia
    function seleccionarSugerencia(texto) {
      document.getElementById('preguntaInput').value = texto;
      document.getElementById('preguntaInput').focus();
    }

    // Funci√≥n antigua remplazada por consultarAgente
    function realizarConsulta(e) {
      e.preventDefault();
      consultarAgente();
    }

    // Agregar al historial
    function agregarAlHistorial(pregunta) {
      const historialContent = document.getElementById('historialContent');
      const nuevoItem = document.createElement('div');
      nuevoItem.className = 'historial-item';
      nuevoItem.onclick = () => cargarConsultaHistorial(pregunta);
      nuevoItem.innerHTML = `
        <i class="far fa-clock" style="margin-right: 8px; color: #5f6368;"></i>
        ${pregunta}
      `;
      historialContent.insertBefore(nuevoItem, historialContent.firstChild);
    }

    // Generar gr√°fica
    function generarGrafica() {
      const ctx = document.getElementById('chartCanvas').getContext('2d');

      if (chartInstance) {
        chartInstance.destroy();
      }

      chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Valle del Cauca', 'Antioquia', 'Cundinamarca', 'Atl√°ntico', 'Bol√≠var'],
          datasets: [{
            label: 'N√∫mero de Contratos',
            data: [12, 19, 8, 5, 11],
            backgroundColor: [
              'rgba(45, 62, 128, 0.8)',
              'rgba(93, 111, 178, 0.8)',
              'rgba(240, 184, 65, 0.8)',
              'rgba(214, 52, 33, 0.8)',
              'rgba(117, 117, 117, 0.8)'
            ],
            borderColor: [
              'rgb(45, 62, 128)',
              'rgb(93, 111, 178)',
              'rgb(240, 184, 65)',
              'rgb(214, 52, 33)',
              'rgb(117, 117, 117)'
            ],
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            title: {
              display: true,
              text: 'Distribuci√≥n de Contratos por Departamento',
              font: {
                size: 14,
                weight: '500'
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                precision: 0
              }
            }
          }
        }
      });
    }

    // Generar tabla
    function generarTabla(datos) {
      if (!datos || datos.length === 0) return;

      const tabla = document.getElementById('tablaResultados');
      const columnas = Object.keys(datos[0]);

      let thead = '<thead><tr><th><input type="checkbox" id="checkboxTodos" onchange="toggleTodos(this)"></th>';
      columnas.forEach(col => thead += `<th>${col}</th>`);
      thead += '</tr></thead>';

      let tbody = '<tbody>';
      datos.forEach((fila, index) => {
        tbody += `<tr id="fila-${index}">`;
        tbody += `<td><input type="checkbox" class="checkbox-fila" onchange="actualizarContador()" data-index="${index}"></td>`;
        columnas.forEach(col => tbody += `<td>${fila[col] || ''}</td>`);
        tbody += '</tr>';
      });
      tbody += '</tbody>';

      tabla.innerHTML = thead + tbody;
    }

    // Toggle todos los checkboxes
    function toggleTodos(checkbox) {
      const checkboxes = document.querySelectorAll('.checkbox-fila');
      checkboxes.forEach(cb => {
        cb.checked = checkbox.checked;
        const fila = cb.closest('tr');
        fila.classList.toggle('selected', checkbox.checked);
      });
      actualizarContador();
    }

    // Actualizar contador
    function actualizarContador() {
      const seleccionados = document.querySelectorAll('.checkbox-fila:checked').length;
      document.getElementById('contadorSeleccionados').textContent =
        `${seleccionados} seleccionado${seleccionados !== 1 ? 's' : ''}`;

      document.querySelectorAll('.checkbox-fila').forEach(cb => {
        cb.closest('tr').classList.toggle('selected', cb.checked);
      });
    }

    // Acciones de tabla
    function seleccionarTodos() {
      document.getElementById('checkboxTodos').checked = true;
      toggleTodos(document.getElementById('checkboxTodos'));
    }

    function deseleccionarTodos() {
      document.getElementById('checkboxTodos').checked = false;
      toggleTodos(document.getElementById('checkboxTodos'));
    }

    function exportarSeleccionados() {
      const seleccionados = obtenerFilasSeleccionadas();
      if (seleccionados.length === 0) {
        alert('Por favor seleccione al menos un contrato');
        return;
      }
      alert(`Exportando ${seleccionados.length} contrato(s)...`);
    }

    function copiarSeleccionados() {
      const seleccionados = obtenerFilasSeleccionadas();
      if (seleccionados.length === 0) {
        alert('Por favor seleccione al menos un contrato');
        return;
      }

      // Convertir a formato Tabular (TSV) para Excel
      if (seleccionados.length > 0) {
        const headers = Object.keys(seleccionados[0]);
        const headerRow = headers.join('\t');

        const rows = seleccionados.map(row => {
          return headers.map(header => {
            let cell = row[header] === null || row[header] === undefined ? '' : String(row[header]);
            // Limpiar saltos de l√≠nea y tabuladores dentro de la celda para no romper formato
            return cell.replace(/[\t\n\r]/g, ' ');
          }).join('\t');
        });

        const tsv = [headerRow, ...rows].join('\n');

        navigator.clipboard.writeText(tsv).then(() => {
          alert('‚úÖ Datos copiados al portapapeles en formato Excel');
        });
      }
    }

    function obtenerFilasSeleccionadas() {
      const checkboxes = document.querySelectorAll('.checkbox-fila:checked');
      const seleccionados = [];
      // Usar datosAgenteActuales si existe (de la tabla generada por agente), sino datosTabla (demo)
      const fuenteDatos = window.datosAgenteActuales || datosTabla;

      checkboxes.forEach(cb => {
        const index = cb.dataset.index;
        if (fuenteDatos[index]) {
          seleccionados.push(fuenteDatos[index]);
        }
      });
      return seleccionados;
    }

    // Logout
    function logout() {
      if (confirm('¬øEst√° seguro que desea cerrar sesi√≥n?')) {
        window.location.href = '/logout/';
      }
    }
  </script>

  <!-- LOGICA DEL AGENTE -->
  <script>
    const searchInput = document.querySelector('.search-input');
    const searchButton = document.querySelector('.search-input-icon');
    const respuestaContainer = document.querySelector('.respuesta-content');
    const tablaContainer = document.querySelector('.tabla-excel-container');
    const graficaContainer = document.querySelector('.chart-wrapper');

    // Funci√≥n para consultar API
    async function consultarAgente() {
      const pregunta = searchInput.value.trim();
      if (!pregunta) return;

      // Mostrar contenedores expl√≠citamente y preparar UI
      document.getElementById('respuestaContainer').style.display = 'block';
      document.getElementById('graficaContainer').style.display = 'block';
      document.getElementById('tablaContainer').style.display = 'block';

      // 1. Crear contenedor temporal para esta interacci√≥n
      const interactionId = Date.now();
      const interactionHtml = `
        <div class="interaction-item" id="interaction-${interactionId}">
          <!-- Pregunta Usuario -->
          <div class="chat-question">
            <i class="fas fa-user chat-icon text-primary"></i>
            <div class="chat-content">
              <strong>Pregunta:</strong> ${pregunta}
            </div>
          </div>
          
          <!-- Respuesta Loading -->
          <div class="chat-answer" id="loading-${interactionId}">
            <i class="fas fa-robot chat-icon text-warning"></i>
            <div class="chat-content">
              <i class="fas fa-spinner fa-spin"></i> Analizando datos...
            </div>
          </div>
        </div>
      `;

      // Append al historial visual
      respuestaContainer.insertAdjacentHTML('beforeend', interactionHtml);

      // Scroll al fondo
      respuestaContainer.scrollTop = respuestaContainer.scrollHeight;

      // Agregar al historial lateral
      agregarAlHistorial(pregunta);
      // Agregar a sugerencias (chips)
      actualizarSugerencias(pregunta);

      // Limpiar input
      searchInput.value = '';

      try {
        const response = await fetch('http://localhost:5000/api/query', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ question: pregunta })
        });

        const data = await response.json();

        // Obtener el contenedor de respuesta de esta interacci√≥n
        const loadingDiv = document.getElementById(`loading-${interactionId}`);
        const interactionDiv = document.getElementById(`interaction-${interactionId}`);

        if (data.error) {
          loadingDiv.innerHTML = `
            <i class="fas fa-exclamation-triangle chat-icon text-danger"></i>
            <div class="chat-content text-danger">Error: ${data.error}</div>
          `;
          return;
        }

        // Reemplazar Loading con Respuesta Real
        let respuestaHtml = `
          <i class="fas fa-robot chat-icon" style="color: var(--naranja-suave);"></i>
          <div class="chat-content">
            <div><strong>Respuesta:</strong></div>
            ${data.respuesta_texto ? (typeof marked !== 'undefined' ? marked.parse(data.respuesta_texto) : data.respuesta_texto.replace(/\n/g, '<br>')) : ''}
          </div>
        `;

        loadingDiv.innerHTML = respuestaHtml;

        // Renderizar Tablas y Gr√°ficas (Actualizan el panel inferior, NO se apilan en el chat por dise√±o actual, 
        // o si se quiere en el chat, habr√≠a que mover el div de gr√°fica DENTRO del chat. 
        // Asumo que "respuesta" se refiere al texto, y las herramientas visuales se actualizan con lo √∫ltimo).

        // 2. Renderizar Tabla (Panel Inferior)
        if (data.respuesta_tabla && Array.isArray(data.respuesta_tabla)) {
          renderizarTabla(data.respuesta_tabla);
          // Opcional: Agregar peque√±o indicador en el chat
        }

        // 3. Renderizar Gr√°fica (Panel Inferior)
        if (data.respuesta_grafica) {
          renderizarGrafica(data.respuesta_grafica);
        }

      } catch (error) {
        console.error(error);
        const loadingDiv = document.getElementById(`loading-${interactionId}`);
        if (loadingDiv) {
          loadingDiv.innerHTML = `
                <i class="fas fa-plug chat-icon text-danger"></i>
                <div class="chat-content text-danger">Error de conexi√≥n con el servidor.</div>
            `;
        }
      }
    }

    // Renderizar Tabla Din√°mica con Checkboxes
    function renderizarTabla(datos) {
      if (datos.length === 0) return;

      const tabla = document.getElementById('tablaResultados'); // Usamos el ID correcto para limpiar todo
      // Limpiar contenido previo si es necesario o sobrescribirlo
      tabla.innerHTML = '';

      // Obtener headers
      const headers = Object.keys(datos[0]);

      let html = '<thead><tr>';
      // Columna de checkbox header
      html += '<th><input type="checkbox" id="checkboxTodos" onchange="toggleTodos(this)"></th>';

      headers.forEach(h => html += `<th>${h.charAt(0).toUpperCase() + h.slice(1)}</th>`);
      html += '</tr></thead><tbody>';

      datos.forEach((row, index) => {
        html += `<tr>`;
        // Columna de checkbox fila
        html += `<td><input type="checkbox" class="checkbox-fila" onchange="actualizarContador()" data-index="${index}"></td>`;

        headers.forEach(h => html += `<td>${row[h]}</td>`);
        html += '</tr>';
      });
      html += '</tbody>';

      // Guardar datos globales para que funcionen las acciones de exportar/copiar
      // Como 'datos' es local, necesitamos actualizar una variable global si queremos que 'obtenerFilasSeleccionadas' funcione.
      // Sin embargo, 'datosTabla' era la variable demo. Vamos a reutilizarla o crear una nueva.
      window.datosAgenteActuales = datos; // Guardar referencia

      tabla.innerHTML = html;
    }

    // Renderizar Gr√°fica Chart.js
    let myChart = null;
    function renderizarGrafica(graficaData) {
      // Limpiar canvas anterior si existe
      graficaContainer.innerHTML = '<canvas id="agentChart"></canvas>';
      const ctx = document.getElementById('agentChart').getContext('2d');

      if (myChart) myChart.destroy();

      const config = {
        type: graficaData.tipo || 'bar',
        data: {
          labels: graficaData.etiquetas,
          datasets: [{
            label: graficaData.titulo || 'Datos',
            data: graficaData.datos,
            backgroundColor: [
              'rgba(54, 162, 235, 0.6)',
              'rgba(255, 99, 132, 0.6)',
              'rgba(255, 206, 86, 0.6)',
              'rgba(75, 192, 192, 0.6)',
              'rgba(153, 102, 255, 0.6)'
            ],
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: graficaData.titulo
            }
          }
        }
      };

      myChart = new Chart(ctx, config);
    }

    // Event Listeners
    if (searchButton) searchButton.addEventListener('click', consultarAgente);
    if (searchInput) {
      searchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') consultarAgente();
      });
    }



    // Gestionar Sugerencias (Chips)
    window.ultimasPreguntas = [];
    function actualizarSugerencias(pregunta) {
      // Evitar duplicados consecutivos si se desea, o simplemente agregar
      // Si ya existe, la movemos al final? O permitimos duplicados? 
      // "solo las ultimas 6". Vamos a filtrar si ya existe para que suba a la posicion mas reciente.
      window.ultimasPreguntas = window.ultimasPreguntas.filter(p => p !== pregunta);
      window.ultimasPreguntas.push(pregunta);

      // Mantener solo ultimas 6
      if (window.ultimasPreguntas.length > 6) {
        window.ultimasPreguntas.shift(); // Eliminar la m√°s antigua
      }

      renderizarSugerencias();
    }

    function renderizarSugerencias() {
      const contenedor = document.getElementById('sugerenciasContainer');
      contenedor.innerHTML = '';

      // Mostrar en orden inverso (la m√°s reciente primero) o cronol√≥gico? 
      // "solo las ultimas 6". Usualmente sugerencias son lo m√°s reciente.
      // Vamos a mostrar las m√°s recientes a la izquierda (principio).
      // Copia invertida para renderizar
      [...window.ultimasPreguntas].reverse().forEach(p => {
        const chip = document.createElement('div');
        chip.className = 'sugerencia-chip';
        chip.innerHTML = `üí° ${p}`;
        chip.onclick = () => seleccionarSugerencia(p);
        contenedor.appendChild(chip);
      });
    }

    // Nueva funci√≥n para reiniciar chat
    async function nuevoChat() {
      if (!confirm('¬øDeseas iniciar un nuevo chat? Esto borrar√° el historial actual.')) return;

      try {
        const response = await fetch('http://localhost:5000/api/reset', { method: 'POST' });
        const data = await response.json();

        if (data.message) {
          // Limpiar UI
          document.getElementById('respuestaContainer').style.display = 'none';
          document.getElementById('respuestaContent').innerHTML = ''; // Limpiar historial visual
          document.getElementById('historialContent').innerHTML = ''; // Limpiar historial lateral
          document.getElementById('sugerenciasContainer').innerHTML = ''; // Limpiar suggest chips
          window.ultimasPreguntas = []; // Reset array
          document.getElementById('graficaContainer').style.display = 'none';
          document.getElementById('tablaContainer').style.display = 'none';
          document.getElementById('preguntaInput').value = '';

          alert('‚úÖ Chat reiniciado. El agente ya no recuerda la conversaci√≥n anterior.');
        } else {
          alert('Error al reiniciar chat: ' + (data.error || 'Desconocido'));
        }
      } catch (error) {
        console.error('Error reset:', error);
        alert('Error conectando con el servidor para reiniciar chat');
      }
    }
  </script>

</body>

</html>